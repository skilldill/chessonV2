# =========================
# Put this INSIDE `http { ... }`
# (e.g. /etc/nginx/nginx.conf or included http-level conf)
# =========================

map $http_user_agent $is_mobile_ua {
    default 0;
    ~*Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera\ Mini 1;
}

# =========================
# Server: game (desktop SPA)
# =========================
server {
    listen 80;
    listen [::]:80;

    server_name game.chesson.me www.game.chesson.me;

    location / {
        proxy_pass http://client:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
        proxy_pass http://api:4000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /ws/ {
        proxy_pass http://api:4000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }
}

# =========================
# Server: mobile SPA
# =========================
server {
    listen 80;
    listen [::]:80;

    server_name mobile.chesson.me www.mobile.chesson.me;

    location / {
        proxy_pass http://mobile:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
        proxy_pass http://api:4000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /ws/ {
        proxy_pass http://api:4000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }
}

# =========================
# Server: chesson.me (site + canonical room links)
# =========================
server {
    listen 80;
    listen [::]:80;

    server_name chesson.me www.chesson.me;

    # Главная страница (лендинг/сайт)
    location = / {
        proxy_pass http://site:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Канонические ссылки комнат:
    # https://chesson.me/<roomId>
    # (ровно один сегмент, чтобы не перехватывать /api/... и прочее)
    location ~ ^/([A-Za-z0-9_-]+)$ {
        set $room_id $1;

        if ($is_mobile_ua) {
            return 302 https://mobile.chesson.me/game/$room_id;
        }

        return 302 https://game.chesson.me/$room_id;
    }

    # Всё остальное отдаём сайту
    location / {
        proxy_pass http://site:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
