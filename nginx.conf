# =========================
# HTTP-level (ДОЛЖНО быть внутри http { ... })
# =========================

# Определяем куда редиректить /game/... по User-Agent
map $http_user_agent $game_target_host {
    default game.chesson.me;
    ~*Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera\ Mini mobile.chesson.me;
}

# Определяем куда редиректить /login по User-Agent
map $http_user_agent $login_target_host {
    default game.chesson.me;
    ~*Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera\ Mini mobile.chesson.me;
}

# Для WebSocket
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# =========================
# Server: game (desktop SPA)
# =========================
server {
    listen 80;
    listen [::]:80;

    server_name game.chesson.me www.game.chesson.me game.chesson.me www.game.chesson.me;

    location / {
        proxy_pass http://client:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /api/ {
        proxy_pass http://api:4000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /ws/ {
        proxy_pass http://api:4000;
        proxy_http_version 1.1;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }
}

# =========================
# Server: mobile SPA
# =========================
server {
    listen 80;
    listen [::]:80;

    server_name mobile.chesson.me www.mobile.chesson.me mobile.chesson.me www.mobile.chesson.me;

    location / {
        proxy_pass http://mobile:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /api/ {
        proxy_pass http://api:4000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /ws/ {
        proxy_pass http://api:4000;
        proxy_http_version 1.1;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }
}

# =========================
# Server: chesson.me (site + canonical room links)
# =========================
server {
    listen 80;
    listen [::]:80;

    server_name chesson.me www.chesson.me chesson.me www.chesson.me;

    # Главная страница (лендинг/сайт)
    location = / {
        proxy_pass http://site:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Канонические ссылки комнат:
    # ВАЖНО: матчим ВСЁ что начинается с /game/ (со слэшем/без, с query, с вложенными роутами)
    location ^~ /game/ {
        # чтобы браузеры не кешировали логику редиректа
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # 307 сохраняет метод, и не такой "липкий", как 301
        return 307 https://$game_target_host$request_uri;
    }

    # Подтверждение email - редирект на client или mobile в зависимости от User-Agent
    location ^~ /verify-email {
        # чтобы браузеры не кешировали логику редиректа
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # 307 сохраняет метод, и не такой "липкий", как 301
        return 307 https://$game_target_host$request_uri;
    }

    # Авторизация - редирект на client или mobile в зависимости от User-Agent
    location = /login {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        return 307 https://$login_target_host$request_uri;
    }

    # Всё остальное отдаём сайту
    location / {
        proxy_pass http://site:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
